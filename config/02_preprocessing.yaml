# =============================================================================
# ÉTAPE 2 : EXTRACTION ET PRÉTRAITEMENT DE DOCUMENTS
# =============================================================================
# Cette étape extrait le texte des documents avec un système de fallback
# robuste. Si un extracteur échoue, le système essaie automatiquement
# le suivant dans la chaîne jusqu'à réussir ou épuiser tous les extracteurs.
#
# Architecture de fallback :
#   1. PyPDF2       → Rapide, léger (PDF textuels simples)
#   2. Docling      → OCR + layout (PDF complexes)
#   3. Marker       → ML-based (haute qualité)
#   4. VLM          → Vision AI (dernier recours, tous documents)
#
# NOTE: L'activation de cette étape est contrôlée dans config/global.yaml
#       via le paramètre steps.preprocessing_enabled
# =============================================================================

# -----------------------------------------------------------------------------
# CONFIGURATION DU SYSTÈME DE FALLBACK
# -----------------------------------------------------------------------------
# Les extracteurs sont essayés dans l'ordre jusqu'à ce qu'un réussisse.
# Chaque extracteur a ses propres critères de validation.
#
fallback:
  enabled: true  # Activer le système de fallback

  # =============================================================================
  # MODE D'EXTRACTION
  # =============================================================================
  # Contrôle l'utilisation des modèles de vision (VLM) pour l'extraction.
  #
  # • use_vlm: false (MODE STANDARD - Recommandé)
  #   → Utilise uniquement les extracteurs classiques (text, pypdf2, docling, marker)
  #   → Plus rapide, moins coûteux, pas de dépendance aux API VLM
  #   → Convient pour 95% des documents (PDF textuels, Office, texte)
  #   → Les images seront IGNORÉES (nécessitent obligatoirement un VLM)
  #
  # • use_vlm: true (MODE VLM - Pour documents visuels complexes)
  #   → Active les extracteurs VLM (image, vlm) dans la chaîne de fallback
  #   → Nécessite un provider VLM configuré dans global.yaml (openai, anthropic, ollama)
  #   → Plus lent, plus coûteux (API payantes pour OpenAI/Anthropic)
  #   → Requis pour : images (.png, .jpg, etc.), PDF très complexes, documents illisibles
  #   → Les extracteurs VLM sont utilisés en DERNIER RECOURS après échec des autres
  #
  use_vlm: true  # false = mode standard (défaut) | true = mode VLM activé

  # =============================================================================
  # PROFIL DE FALLBACK (Stratégies prédéfinies)
  # =============================================================================
  # Choisissez le profil adapté à votre besoin :
  #
  # • speed       : Privilégie la rapidité (Text → PyPDF2)
  #                 → Meilleur pour : Gros volumes, PDF textuels simples
  #                 → RAM : ~50 MB | Vitesse : ⚡⚡⚡⚡⚡ | Qualité : ⭐⭐
  #                 → Extracteurs : text, pypdf2
  #
  # • memory      : Minimise l'utilisation mémoire (Text → PyPDF2 → Docling)
  #                 → Meilleur pour : Serveurs limités en RAM, PDF variés
  #                 → RAM : ~200 MB | Vitesse : ⚡⚡⚡⚡ | Qualité : ⭐⭐⭐
  #                 → Extracteurs : text, pypdf2, docling
  #
  # • compromise  : Équilibre qualité/performance (Text → PyPDF2 → Docling)
  #                 → Meilleur pour : Usage général, documents professionnels
  #                 → RAM : ~300 MB | Vitesse : ⚡⚡⚡ | Qualité : ⭐⭐⭐⭐
  #                 → Extracteurs : text, pypdf2, docling (+ image si use_vlm=true)
  #
  # • quality     : Maximise la qualité (Text → Marker → Docling → Image → VLM)
  #                 → Meilleur pour : Documents critiques, PDF complexes
  #                 → RAM : ~2 GB | Vitesse : ⚡⚡ | Qualité : ⭐⭐⭐⭐⭐
  #                 → Extracteurs : text, marker, docling (+ image, vlm si use_vlm=true)
  #
  # • custom      : Configuration manuelle (voir section extractors ci-dessous)
  #                 → Meilleur pour : Besoins spécifiques, fine-tuning
  #                 → Extracteurs : définis manuellement dans la section extractors
  #
  # IMPORTANT : Le paramètre use_vlm (ci-dessus) filtre automatiquement les
  #             extracteurs VLM (image, vlm). Si use_vlm=false, ces extracteurs
  #             seront ignorés même s'ils sont définis dans le profil.
  #
  # NOTE : Si "custom", la section "extractors" ci-dessous sera utilisée.
  #        Sinon, le profil prédéfini remplacera la configuration extractors.
  #
  profile: "custom"  # Options : speed | memory | compromise | quality | custom

  # =============================================================================
  # CONFIGURATION EXTRACTEURS (utilisée uniquement si profile: "custom")
  # =============================================================================
  # Liste des extracteurs dans l'ordre de priorité (du plus rapide au plus lent)
  # Format : [nom_extracteur, config_extracteur]
  # ORDRE OPTIMISÉ 2025 : text → docling (Tesseract) → pdfplumber → pymupdf → pypdf2
  extractors:
    # 0️⃣ Text - Extracteur pour fichiers texte simples (.txt, .md, .csv, .xml, .html, etc.)
    - name: "text"
      enabled: true
      config:
        min_text_length: 10
        fallback_encodings: ["utf-8", "latin-1", "cp1252", "iso-8859-1"]
        strip_html: true  # Pour fichiers .html

    # 1️⃣ Docling - Extracteur avancé avec OCR Tesseract (recommandé)
    # Utilise Tesseract OCR au lieu d'ocrmac pour éviter les bugs
    # Excellent pour PDFs complexes, tableaux, layout analysis, et PDFs scannés
    - name: "docling"
      enabled: true  # ✅ Activé avec Tesseract OCR
      config:
        ocr_enabled: true  # Activer OCR pour PDF scannés
        ocr_lang: ["fra"]  # Liste de langues OCR (["fra"], ["eng"], ["fra", "eng"])
        ocr_skip_osd: true  # Skip OSD (Orientation & Script Detection) en cas d'erreur
        ocr_psm: 3  # Page Segmentation Mode (3 = auto sans OSD, évite erreurs "OSD failed")
        preserve_layout: true  # Préserver la mise en page
        extract_tables: true  # Extraire les tableaux structurés
        extract_images: false  # Ne pas extraire les images (optionnel)
        min_text_length: 50
        min_confidence: 0.8  # Haute confiance pour Docling avec Tesseract

    # 2️⃣ PDFPlumber - Extracteur PDF rapide et fiable (fallback)
    # Utilisé si Docling échoue, excellent pour PDF textuels et tableaux
    - name: "pdfplumber"
      enabled: true
      config:
        extract_tables: true  # Extraire les tableaux structurés
        extract_text: true  # Extraire le texte
        min_text_length: 100  # Minimum 100 caractères
        min_confidence: 0.7  # Score minimum (pdfplumber est fiable)

    # 3️⃣ PyMuPDF - Extracteur PDF très rapide avec fitz
    # Fallback si pdfplumber échoue, excellent pour PDFs simples
    - name: "pymupdf"
      enabled: true
      config:
        extract_images: false  # Ne pas extraire les images
        min_text_length: 100
        min_confidence: 0.6

    # 4️⃣ PyPDF2 - Extracteur PDF simple et léger
    # Dernier fallback pour PDFs basiques
    - name: "pypdf2"
      enabled: true
      config:
        min_text_length: 100  # Minimum 100 caractères pour considérer succès
        extract_metadata: true
        min_confidence: 0.3  # Score minimum pour accepter le résultat

    # 4️⃣ Marker - Extracteur ML haute qualité (lent mais précis)
    # Utilisé seulement si tous les extracteurs rapides échouent
    - name: "marker"
      enabled: false  # Désactivé par défaut (très lent)
      config:
        use_gpu: false  # Utiliser GPU si disponible (accélère traitement)
        batch_size: 1  # Nombre de pages traitées simultanément
        max_pages: null  # Limite de pages (null = toutes)
        min_text_length: 50
        min_confidence: 0.6

    # 4️⃣ VLM - Vision Language Model (dernier recours, très lent)
    # Utilise un modèle vision (GPT-4V, Claude 3, etc.) pour lire visuellement
    # IMPORTANT: Le provider doit être défini dans global.yaml > llm_providers
    - name: "vlm"
      enabled: false  # Désactivé par défaut (coûteux et lent)
      config:
        # Provider depuis global.yaml (openai, anthropic, ollama)
        provider: "mistral_ai"
        # Modèles VLM disponibles:
        # • openai    : gpt-4-vision-preview, gpt-4o, gpt-4-turbo
        # • anthropic : claude-3-opus-20240229, claude-3-sonnet-20240229
        # • ollama    : llava:13b, llava:7b, bakllava (gratuit, local)
        model: "pixtral-12b"
        temperature: 0.0  # Déterministe
        max_tokens_per_page: 2000  # Tokens max par page
        max_pages: 10  # Limiter à 10 pages max (coût)
        image_dpi: 200  # Résolution des images générées
        min_text_length: 50
        min_confidence: 0.4

        # Prompts personnalisables pour extraction VLM
        # Le prompt par défaut est 'text_extraction'
        default_prompt: "text_extraction"

        prompts:
          text_extraction: |
            Extrait tout le texte de cette page de document.
            Préserve la structure et le formatage autant que possible.
            Inclus tout le texte visible, les tableaux et les légendes.
            Retourne uniquement le texte extrait sans aucun commentaire.

          table_extraction: |
            Extrait tous les tableaux de cette page de document au format markdown.
            Pour chaque tableau :
            - Préserve la structure avec des séparateurs |
            - Inclus les en-têtes
            - Maintiens l'alignement des cellules
            Retourne uniquement les tableaux sans commentaire additionnel.

          metadata_extraction: |
            Extrait les métadonnées de cette page de document.
            Identifie et retourne :
            - Titre du document
            - Auteur(s)
            - Date(s)
            - Type de document
            - Numéros de page
            - Titres de section
            Retourne au format JSON structuré.

          image_description: |
            Décris toutes les images, graphiques et diagrammes de cette page.
            Pour chaque élément visuel, fournis :
            - Type (photo, graphique, diagramme, logo, etc.)
            - Description du contenu
            - Tout texte ou étiquette visible
            - Contexte dans le document
            Retourne les descriptions dans un format clair et structuré.

  # Stratégie de validation des résultats
  validation:
    # Critères globaux pour tous les extracteurs
    min_text_length: 50  # Minimum absolu de caractères
    max_empty_ratio: 0.5  # Max 50% de pages vides tolérées

    # Stratégie de sélection si plusieurs extracteurs réussissent
    selection_strategy: "first_success"  # Options: first_success, best_confidence, longest_text

# -----------------------------------------------------------------------------
# NETTOYAGE DU TEXTE EXTRAIT
# -----------------------------------------------------------------------------
# Traitement appliqué AU TEXTE FINAL (après extraction réussie)
#
cleaning:
  # Nettoyage structurel
  remove_headers_footers: true  # Supprimer en-têtes et pieds de page répétitifs
  remove_page_numbers: true  # Supprimer numéros de page
  normalize_whitespace: true  # Normaliser les espaces multiples
  remove_special_chars: false  # Conserver caractères spéciaux

  # Transformations
  lowercase: false  # Pas de conversion en minuscules (préserve casse)
  strip_html: true  # Supprimer balises HTML si présentes

  # Filtrage
  min_line_length: 10  # Supprimer lignes < 10 caractères
  remove_empty_lines: true  # Supprimer lignes vides

# -----------------------------------------------------------------------------
# TRAITEMENT DU TEXTE
# -----------------------------------------------------------------------------
text_processing:
  # Contraintes de taille
  min_text_length: 100  # Document minimum 100 caractères
  max_text_length: 10000000  # Document maximum 10M caractères

  # Encodage
  encoding: "utf-8"  # Encodage par défaut
  fallback_encodings:  # Encodages de secours si UTF-8 échoue
    - "latin-1"
    - "cp1252"

# -----------------------------------------------------------------------------
# GESTION D'ERREURS
# -----------------------------------------------------------------------------
error_handling:
  # Comportement en cas d'échec de TOUS les extracteurs
  skip_on_error: false  # False = lever exception, True = ignorer document
  log_errors: true  # Journaliser les erreurs

  # Retry au niveau global (avant de lancer la chaîne de fallback)
  retry_count: 1  # Nombre de tentatives de la chaîne complète
  retry_delay_seconds: 2  # Délai entre tentatives

# -----------------------------------------------------------------------------
# MÉTADONNÉES D'EXTRACTION
# -----------------------------------------------------------------------------
metadata:
  # Métadonnées à collecter durant l'extraction
  include_extraction_method: true  # Enregistrer quel extracteur a réussi
  include_extraction_time: true  # Temps d'extraction
  include_confidence_score: true  # Score de confiance

  # Métadonnées du fichier
  include_file_info: true  # Info fichier de base (taille, format, dates système, etc.)

  # Métadonnées embarquées dans le document
  # Ces métadonnées sont extraites des propriétés du document (PDF metadata, Office properties)
  extract_embedded_metadata: true  # Activer l'extraction des métadonnées embarquées
  embedded_metadata_fields:
    - "title"           # Document title (Titre du document)
    - "author"          # Author(s) (Auteur(s))
    - "creator"         # Creator/Application (Créateur/Application)
    - "producer"        # Producer (Producteur, pour PDF)
    - "subject"         # Subject (Sujet)
    - "keywords"        # Keywords (Mots-clés embarqués)
    - "creation_date"   # Date(s) - Date de création
    - "modification_date"  # Date de modification
    - "document_type"   # Document type (si disponible dans metadata)

# -----------------------------------------------------------------------------
# CONFIGURATION DE SÉCURITÉ
# -----------------------------------------------------------------------------
# Paramètres de sécurité pour l'ingestion et le traitement des fichiers.
# Protection contre les fichiers malveillants, abus et attaques DoS.
#
security:
  # Taille maximale des fichiers (protection contre DoS)
  max_file_size_mb: 100  # Maximum 100 MB par fichier

  # Extensions de fichiers autorisées (whitelist stricte)
  # IMPORTANT: Liste complète des 24+ extensions supportées
  allowed_extensions:
    # IMPORTANT: Cette liste DOIT être synchronisée avec:
    # - config/parser.yaml > preprocessing > file_categories
    # - config/01_monitoring.yaml > file_patterns
    # Total: 39 extensions supportées

    # Texte simple (11 extensions)
    - ".txt"       # Texte brut
    - ".log"       # Fichiers de logs
    - ".md"        # Markdown
    - ".markdown"  # Markdown (variante)
    - ".csv"       # Comma-Separated Values
    - ".tsv"       # Tab-Separated Values
    - ".xml"       # Extensible Markup Language
    - ".html"      # Pages web
    - ".htm"       # Pages web (variante)
    - ".rtf"       # Rich Text Format
    - ".tex"       # LaTeX source (stub)
    - ".svg"       # Scalable Vector Graphics (stub)

    # PDF et formats similaires (3 extensions)
    - ".pdf"   # Portable Document Format
    - ".ps"    # PostScript (stub)
    - ".epub"  # E-book

    # Microsoft Office (9 extensions)
    - ".doc"   # Word ancien
    - ".docx"  # Word
    - ".docm"  # Word macro
    - ".ppt"   # PowerPoint ancien
    - ".pptx"  # PowerPoint
    - ".pptm"  # PowerPoint macro
    - ".xls"   # Excel ancien
    - ".xlsx"  # Excel
    - ".xlsm"  # Excel macro

    # LibreOffice/OpenDocument (3 extensions)
    - ".odt"  # Text
    - ".odp"  # Presentation
    - ".ods"  # Spreadsheet

    # Images (8 extensions - OCR requis)
    - ".png"   # PNG image
    - ".jpg"   # JPEG image
    - ".jpeg"  # JPEG image (variante)
    - ".tiff"  # TIFF image
    - ".tif"   # TIFF image (variante)
    - ".bmp"   # Bitmap
    - ".webp"  # WebP image
    - ".gif"   # Graphics Interchange Format

  # Scanner antivirus (intégration optionnelle)
  virus_scan:
    enabled: false  # Désactivé par défaut, activer en production
    scanner: "clamav"  # Options: clamav, defender, custom
    quarantine_on_detection: true  # Mettre en quarantaine si malware détecté

  # Validation du contenu
  content_validation:
    check_magic_bytes: true  # Vérifier que l'extension correspond au contenu
    reject_encrypted: false  # Rejeter fichiers chiffrés/protégés par mot de passe
    reject_corrupted: true  # Rejeter fichiers corrompus

  # Protection contre l'injection
  sanitization:
    remove_macros: false  # Désactiver macros Office (si possible)
    strip_metadata: false  # Supprimer métadonnées EXIF/propriétés (optionnel)
    check_embedded_files: false  # Vérifier fichiers embarqués (ZIP dans DOCX)
